# Claude Code vs Codex 提取结果对比分析

> 状态: ✅ 完成
> 测试日期: 2026-02-25
> 数据来源: `findings/cc-e2e-result.md`, `findings/codex-e2e-result.md`

## 1. 消息格式差异

### 1.1 终端输出格式

| 特性 | Claude Code | Codex |
|------|-------------|-------|
| TUI 框架 | Ink (React/Node) | ratatui (Rust) |
| 消息边界 | `⏺` 符号 | 水平分隔线 `────────` |
| 用户提示符 | `❯` / `>` | `›` |
| 状态指示 | 文本动画 (✶ Brewing…) | `Working... Xs (esc to interrupt)` |
| 上下文显示 | 底部状态栏 `███░░░░░░░ 30%` | `96% context left` |
| 版本显示 | ASCII Logo + 版本号 | 信息框 `╭───╮` |

### 1.2 问题呈现方式

| 类型 | Claude Code | Codex |
|------|-------------|-------|
| 选择题格式 | 数字列表 `1. 2. 3. 4.` | 数字列表 `1. 2. 3.` |
| 确认题 | `[Y/n]` 或 `(yes/no)` | `y/n` |
| 权限请求 | 内联提示 | ApprovalOverlay (`y/n/a/p`) |
| 回复提示 | "你倾向哪个方向？" | "回复一个数字即可" |

### 1.3 实际终端快照对比

**Claude Code**:
```
⏺ 这是一个空项目目录。让我开始了解你的笔记 web app 想法。

  第一个问题：这个笔记应用的主要用途是什么？

  1. 个人知识管理 - 类似 Notion/Obsidian，支持双向链接、知识图谱
  2. 快速记录 - 类似便签，轻量快速，随手记
  3. 协作笔记 - 多人实时编辑，团队共享
  4. 特定场景 - 比如会议记录、日记、代码片段收集等

  你倾向哪个方向？或者有其他想法？

────────────────────────────────────────────────────────────────────────────────
❯
```

**Codex**:
```
• 使用技能：brainstorming（先澄清需求）和 terminal-title（标记当前任务）。

  我先确认到当前仓库是空的（还没有代码和提交）。第一问：这个笔记 Web App 的首版
  目标更接近哪一种？

  1. 个人笔记：快速记录、标签、全文搜索
  2. 团队协作：共享笔记、权限、评论
  3. PKM 导向：双向链接、知识图谱、每日笔记

  回复一个数字即可。

› Write tests for @filename
```

---

## 2. 提取准确率对比

### 2.1 Claude Code 测试结果

| 测试场景 | 结果 | 说明 |
|----------|------|------|
| 状态检测 | ✅ PASS | 返回 `DECISION`，置信度 0.9 |
| 消息提取 | ⚠️ TIMEOUT | 超时 (>5s)，使用 fallback |
| Fingerprint 生成 | ✅ PASS | `11344950374315898548` |
| 去重机制 | ✅ PASS | 相同内容不重复发送 |
| 通知发送 | ✅ PASS | Webhook 成功 |

**准确率**: 4/5 (80%) - 消息提取超时影响

### 2.2 Codex 测试结果

| 测试场景 | 结果 | 说明 |
|----------|------|------|
| 状态检测 | ✅ PASS | 返回 `DECISION`，置信度 0.9 |
| 消息提取 | ✅ PASS | 成功提取（无超时） |
| Fingerprint 生成 | ✅ PASS | `16087390289558788195` |
| 去重机制 | ✅ PASS | 正常工作 |
| 通知发送 | ✅ PASS | Webhook 成功 |

**准确率**: 5/5 (100%)

### 2.3 差异原因分析

| 差异点 | Claude Code | Codex | 原因 |
|--------|-------------|-------|------|
| 消息提取 | 超时 | 成功 | Claude Code 终端快照更长（含 ASCII Logo），prompt 更大 |
| 状态检测 | 相同 | 相同 | AI 能正确识别两种格式的 DECISION 状态 |
| 置信度 | 0.9 | 0.9 | 两者问题格式清晰，AI 判断一致 |

**关键发现**: ReAct 提取器对两种 Agent 的状态检测表现一致，差异主要在消息提取的性能上。

---

## 3. 性能对比

### 3.1 耗时对比

| 操作 | Claude Code | Codex | 差异 |
|------|-------------|-------|------|
| 状态检测 (第1次) | 1963ms | ~2000ms | 相近 |
| 状态检测 (第2次) | 1860ms | - | - |
| 消息提取 | >5000ms (超时) | ~3000ms | Codex 更快 |
| Webhook 发送 | 23ms | ~20ms | 相近 |
| 总耗时 | ~9s | ~5s | Codex 快 44% |

### 3.2 终端快照大小

| Agent | 快照行数 | 特殊元素 |
|-------|----------|----------|
| Claude Code | ~70 行 | ASCII Logo、状态栏、MCP 统计 |
| Codex | ~30 行 | 信息框、上下文百分比 |

**分析**: Claude Code 终端快照包含更多 UI 元素，导致 prompt 更长，API 响应更慢。

### 3.3 上下文扩展

由于两个测试都在首次尝试（80 行）时成功检测到 DECISION 状态，未触发上下文扩展机制。

| Agent | 初始行数 | 扩展次数 | 最终行数 |
|-------|----------|----------|----------|
| Claude Code | 80 | 0 | 80 |
| Codex | 80 | 0 | 80 |

---

## 4. 发现的问题

### 4.1 Claude Code 特有问题

| 问题 | 优先级 | 影响 | 建议 |
|------|--------|------|------|
| 消息提取超时 | P1 | 通知内容未格式化 | 增加超时到 15s 或优化 prompt |
| 终端快照过大 | P2 | API 响应慢 | 预处理过滤 UI 噪音 |

### 4.2 Codex 特有问题

| 问题 | 优先级 | 影响 | 建议 |
|------|--------|------|------|
| 初始 prompt 传递 | P2 | 需要手动输入 | 使用 `tmux send-keys` |
| 信任确认阻塞 | P3 | 自动化流程中断 | 使用 `--full-auto` |

### 4.3 共同问题

| 问题 | 影响 | 建议 |
|------|------|------|
| 事件名称大小写 | 小写事件被跳过 | 统一大小写处理 |

---

## 5. 改进建议

### 5.1 针对 Claude Code 的优化

1. **增加消息提取超时**
   - 当前: 5000ms
   - 建议: 15000ms
   - 原因: Claude Code 终端快照较大，需要更多处理时间

2. **预处理终端快照**
   - 过滤 ASCII Logo 和状态栏
   - 只保留对话区域内容
   - 预期减少 50% token 消耗

3. **优化 prompt 长度**
   - 压缩规则描述
   - 使用更简洁的示例

### 5.2 针对 Codex 的优化

1. **自动化 prompt 传递**
   ```bash
   # 启动后通过 tmux send-keys 发送
   tmux send-keys -t $session "$prompt" Enter
   ```

2. **跳过信任确认**
   - 使用 `--full-auto` 参数
   - 或预配置 `trust_level = "trusted"`

3. **处理版本更新提示**
   - 检测并自动关闭更新提示框

### 5.3 通用改进建议

1. **统一状态检测**
   - 两种 Agent 都返回 `DECISION`，AI 判断一致
   - 无需针对特定 Agent 调整

2. **Fingerprint 策略**
   - 当前使用数字哈希，两者表现一致
   - 建议保持现有策略

3. **超时配置分离**
   - 状态检测: 5s（足够）
   - 消息提取: 15s（需要更多时间）

4. **终端快照预处理**
   - 统一过滤 UI 噪音（Logo、状态栏、进度条）
   - 只保留对话内容

---

## 6. 结论

### 6.1 兼容性评估

| 维度 | 评估 | 说明 |
|------|------|------|
| 状态检测 | ✅ 完全兼容 | 两者都正确识别为 DECISION |
| 消息提取 | ⚠️ 部分兼容 | Claude Code 超时，Codex 正常 |
| 去重机制 | ✅ 完全兼容 | Fingerprint 生成一致 |
| 通知发送 | ✅ 完全兼容 | Webhook 都成功 |

### 6.2 总体评价

ReAct 提取器对 Claude Code 和 Codex 的**状态检测**表现一致，AI 能够正确识别两种不同格式的选择题场景。主要差异在于：

1. **性能**: Codex 快 44%（终端快照更小）
2. **稳定性**: Codex 更稳定（无超时）
3. **格式**: 两者问题格式相似（都用数字列表）

### 6.3 优先修复项

1. **P1**: 增加 Claude Code 消息提取超时
2. **P2**: 预处理终端快照过滤 UI 噪音
3. **P3**: Codex 自动化 prompt 传递

---

## 7. 测试数据来源

- `findings/cc-e2e-result.md` - Claude Code E2E 测试结果
- `findings/codex-e2e-result.md` - Codex E2E 测试结果
- `findings/claude-code-format.md` - Claude Code 格式研究
- `findings/codex-format.md` - Codex 格式研究
- `design/react-extractor.md` - ReAct 提取器设计
- `design/ai-prompts.md` - AI Prompt 设计

---

## 8. 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2026-02-25 | 完成对比分析，填充测试数据 |
| 0.1 | 2026-02-25 | 初始模板 |
