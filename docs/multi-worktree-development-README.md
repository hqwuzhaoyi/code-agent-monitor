# Multi-Worktree Multi-Agent Development - README

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ **git worktrees + å¤šä»£ç†å›¢é˜Ÿ** çš„æ–¹å¼å¹¶è¡Œå¼€å‘é‡å¤é€šçŸ¥ä¿®å¤åŠŸèƒ½ã€‚

## æ¶æ„è®¾è®¡

### Git Worktrees ç»“æ„

```
code-agent-monitor/
â”œâ”€â”€ .worktrees/
â”‚   â”œâ”€â”€ dedup-fix/      # æ ¸å¿ƒå®ç°åˆ†æ”¯
â”‚   â”œâ”€â”€ testing/        # æµ‹è¯•å¼€å‘åˆ†æ”¯
â”‚   â”œâ”€â”€ review/         # ä»£ç è¯„å®¡åˆ†æ”¯
â”‚   â””â”€â”€ docs/           # æ–‡æ¡£ç¼–å†™åˆ†æ”¯
â”œâ”€â”€ main (ä¸»åˆ†æ”¯)
â””â”€â”€ docs/
    â”œâ”€â”€ duplicate-notification-fix-v3.md  # æœ€ç»ˆå®ç°æ–¹æ¡ˆ
    â””â”€â”€ worktree-team-coordination.md     # å›¢é˜Ÿåè°ƒæ–‡æ¡£
```

### å¤šä»£ç†å›¢é˜Ÿ

| ä»£ç† | èŒè´£ | Worktree | çŠ¶æ€ |
|------|------|----------|------|
| **plan-reviewer** | åˆ†æ v2 æ–¹æ¡ˆé—®é¢˜ï¼Œæå‡ºä¿®æ­£ | main | âœ… å®Œæˆ |
| **dedup-key-developer** | å®ç°ç»Ÿä¸€å»é‡é”®ç”Ÿæˆå™¨ | dedup-fix | ğŸ”„ è¿›è¡Œä¸­ |
| **test-engineer** | ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• | testing | ğŸ”„ è¿›è¡Œä¸­ |
| **tech-writer** | åˆ›å»ºå®Œæ•´æ–‡æ¡£ | docs | ğŸ”„ è¿›è¡Œä¸­ |
| **code-reviewer** | æ‰§è¡Œä»£ç è¯„å®¡ | review | â³ ç­‰å¾…ä¸­ |

## å…³é”®å‘ç°

### plan-reviewer çš„è¯„å®¡ç»“æœ

éªŒè¯äº† 6 ä¸ªå…³é”®é—®é¢˜ï¼Œæœ€é‡è¦çš„å‘ç°ï¼š

**ğŸ”´ HIGH: Dedup State Sync Problem**
- é—®é¢˜ï¼šwatcher å’Œ notifier å„è‡ªæŒæœ‰ç‹¬ç«‹çš„å†…å­˜å»é‡å™¨
- å½±å“ï¼šå³ä½¿æœ‰ç»Ÿä¸€çš„ dedup keyï¼Œè·¨è¿›ç¨‹å»é‡ä»ä¼šå¤±è´¥
- è§£å†³ï¼šåœ¨ `should_send()` ä¸­æ·»åŠ  `self.load_state()` é‡æ–°åŠ è½½çŠ¶æ€

**ğŸ”´ HIGH: Terminal Snapshot Timing**
- é—®é¢˜ï¼šv2 æè®®é‡æ–°æ•è·ç»ˆç«¯å¿«ç…§
- å½±å“ï¼šè¿å"ä½¿ç”¨ç›¸åŒåŸå§‹å¿«ç…§"åŸåˆ™
- è§£å†³ï¼šä½¿ç”¨ `event.terminal_snapshot` å·²æœ‰å­—æ®µ

å…¶ä»– 4 ä¸ªé—®é¢˜è¯¦è§ `docs/duplicate-notification-fix-v3.md`

## å®ç°æ–¹æ¡ˆ (v3)

### Phase 1: ç»Ÿä¸€å»é‡é”®ç”Ÿæˆå™¨
```rust
// src/notification/dedup_key.rs
pub fn generate_dedup_key(terminal_snapshot: &str) -> String {
    let normalized = normalize_terminal_content(terminal_snapshot);
    let hash = hash_content(&normalized);
    format!("{:016x}", hash)
}
```

### Phase 2: ä¿®å¤å»é‡çŠ¶æ€åŒæ­¥ (å…³é”®!)
```rust
// src/notification/deduplicator.rs
pub fn should_send(&mut self, agent_id: &str, content: &str) -> NotifyAction {
    self.load_state();  // å…³é”®ä¿®å¤ï¼šé‡æ–°åŠ è½½çŠ¶æ€
    // ... ç°æœ‰é€»è¾‘
}
```

### Phase 3-5: é›†æˆåˆ° watcher å’Œ hooks
- æ›´æ–° watcher ä½¿ç”¨ç»Ÿä¸€ key
- æ›´æ–° hook è·¯å¾„ä½¿ç”¨ç»Ÿä¸€ key
- æ·»åŠ  dedup_key åˆ° NotificationEvent

## ä½¿ç”¨æŒ‡å—

### æŸ¥çœ‹æ‰€æœ‰ worktrees
```bash
git worktree list
```

### åˆ‡æ¢åˆ°ç‰¹å®š worktree
```bash
cd .worktrees/dedup-fix    # æ ¸å¿ƒå®ç°
cd .worktrees/testing      # æµ‹è¯•å¼€å‘
cd .worktrees/review       # ä»£ç è¯„å®¡
cd .worktrees/docs         # æ–‡æ¡£ç¼–å†™
```

### æŸ¥çœ‹å›¢é˜Ÿè¿›åº¦
```bash
cam team-progress worktree-dev-team
```

### æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
åœ¨ Claude Code ä¸­ï¼š
```
TaskList
```

## å¼€å‘å·¥ä½œæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 1: å¹¶è¡Œå¼€å‘                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  plan-reviewer          dedup-key-developer                 â”‚
â”‚  â”œâ”€ åˆ†æé—®é¢˜ âœ…          â”œâ”€ å®ç° dedup_key.rs ğŸ”„             â”‚
â”‚  â””â”€ æå‡ºä¿®æ­£ âœ…          â””â”€ ä¿®å¤ should_send() ğŸ”„            â”‚
â”‚                                                              â”‚
â”‚  test-engineer          tech-writer                         â”‚
â”‚  â”œâ”€ å•å…ƒæµ‹è¯• ğŸ”„          â”œâ”€ README ğŸ”„                        â”‚
â”‚  â”œâ”€ é›†æˆæµ‹è¯• ğŸ”„          â”œâ”€ å®ç°æŒ‡å— ğŸ”„                      â”‚
â”‚  â””â”€ è·¨è¿›ç¨‹æµ‹è¯• ğŸ”„        â””â”€ æµ‹è¯•æŒ‡å— ğŸ”„                      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 2: é›†æˆä¸è¯„å®¡                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. é›†æˆ dedup_key.rs åˆ° watcher                            â”‚
â”‚  2. é›†æˆ dedup_key.rs åˆ° hooks                              â”‚
â”‚  3. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶                                         â”‚
â”‚  4. code-reviewer æ‰§è¡Œè¯„å®¡                                  â”‚
â”‚  5. å¤„ç†è¯„å®¡åé¦ˆ                                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 3: åˆå¹¶ä¸éƒ¨ç½²                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. åˆå¹¶ feature/dedup-fix â†’ main                           â”‚
â”‚  2. åˆå¹¶ feature/testing â†’ main                             â”‚
â”‚  3. åˆå¹¶ feature/docs â†’ main                                â”‚
â”‚  4. æ„å»ºå‘å¸ƒç‰ˆæœ¬                                            â”‚
â”‚  5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ                                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```bash
cd .worktrees/testing
cargo test dedup_key
```

### é›†æˆæµ‹è¯•
```bash
cargo test --test integration_test
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# 1. å¯åŠ¨ watcher
cam watch

# 2. è§¦å‘ agent é—®é¢˜
cd ~/workspace/react-todo-list
openclaw
# è§¦å‘å¤´è„‘é£æš´é—®é¢˜

# 3. ç›‘æ§æ—¥å¿—
tail -f ~/.config/code-agent-monitor/hook.log

# 4. éªŒè¯åªå‘é€ä¸€æ¬¡é€šçŸ¥
```

## æˆåŠŸæ ‡å‡†

- âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… ä»£ç è¯„å®¡æ‰¹å‡†
- âœ… æ–‡æ¡£å®Œæ•´
- âœ… é‡å¤é€šçŸ¥ç‡ < 1%
- âœ… è·¨è¿›ç¨‹å»é‡ 100% æœ‰æ•ˆ
- âœ… å‘åå…¼å®¹
- âœ… æ€§èƒ½å¯æ¥å— (< 5ms å¼€é”€)

## å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `docs/duplicate-notification-fix-v3.md` | æœ€ç»ˆå®ç°æ–¹æ¡ˆ (ä¿®æ­£ç‰ˆ) |
| `docs/worktree-team-coordination.md` | å›¢é˜Ÿåè°ƒæ–‡æ¡£ |
| `src/notification/dedup_key.rs` | ç»Ÿä¸€å»é‡é”®ç”Ÿæˆå™¨ (æ–°å¢) |
| `src/notification/deduplicator.rs` | å»é‡å™¨ (éœ€ä¿®æ”¹ should_send) |
| `src/agent_mod/watcher.rs` | Watcher (éœ€é›†æˆç»Ÿä¸€ key) |
| `src/notification/openclaw.rs` | Hook è·¯å¾„ (éœ€é›†æˆç»Ÿä¸€ key) |
| `tests/dedup_key_test.rs` | å•å…ƒæµ‹è¯• (æ–°å¢) |
| `tests/integration_test.rs` | é›†æˆæµ‹è¯• (éœ€æ›´æ–°) |

## æ„å»ºä¸éƒ¨ç½²

### æ„å»º
```bash
cargo build --release
```

### éƒ¨ç½²
```bash
cp target/release/cam plugins/cam/bin/cam
openclaw gateway restart
```

### é‡å¯ watcher
```bash
kill $(cat ~/.config/code-agent-monitor/watcher.pid) 2>/dev/null
cam watch &
```

## å›¢é˜Ÿç®¡ç†

### æŸ¥çœ‹å›¢é˜ŸçŠ¶æ€
```bash
cam team-progress worktree-dev-team
```

### å…³é—­å›¢é˜Ÿ
```bash
cam team-shutdown worktree-dev-team
```

æˆ–é€šè¿‡ SendMessage:
```
SendMessage type=shutdown_request to each agent
```

## æ¸…ç† Worktrees

å®Œæˆåæ¸…ç†ï¼š
```bash
git worktree remove .worktrees/dedup-fix
git worktree remove .worktrees/testing
git worktree remove .worktrees/review
git worktree remove .worktrees/docs
```

## å­¦åˆ°çš„ç»éªŒ

### âœ… æœ‰æ•ˆçš„åšæ³•
1. **å¹¶è¡Œå¼€å‘**: å¤šä¸ª worktree å…è®¸ä»£ç†åŒæ—¶å·¥ä½œ
2. **ä¸“ä¸šåˆ†å·¥**: æ¯ä¸ªä»£ç†ä¸“æ³¨äºç‰¹å®šé¢†åŸŸ
3. **ä»£ç è¯„å®¡**: plan-reviewer å‘ç°äº† 6 ä¸ªå…³é”®é—®é¢˜
4. **æ–‡æ¡£å…ˆè¡Œ**: v3 æ–¹æ¡ˆåœ¨å®ç°å‰å°±ä¿®æ­£äº†é—®é¢˜

### âš ï¸ éœ€è¦æ³¨æ„
1. **è·¨è¿›ç¨‹çŠ¶æ€åŒæ­¥**: æœ€å®¹æ˜“è¢«å¿½ç•¥çš„é—®é¢˜
2. **ä½¿ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**: ä¸è¦é‡å¤é€ è½®å­
3. **éªŒè¯å‡è®¾**: æ£€æŸ¥å®é™…ä»£ç ï¼Œä¸è¦å‡è®¾
4. **æµ‹è¯•è·¯å¾„**: ä½¿ç”¨é¡¹ç›®å®é™…çš„æµ‹è¯•ç»“æ„

## ä¸‹ä¸€æ­¥

1. â³ ç­‰å¾… dedup-key-developer å®Œæˆå®ç°
2. â³ ç­‰å¾… test-engineer å®Œæˆæµ‹è¯•
3. â³ ç­‰å¾… tech-writer å®Œæˆæ–‡æ¡£
4. â³ code-reviewer æ‰§è¡Œè¯„å®¡
5. â³ é›†æˆæ‰€æœ‰æ›´æ”¹
6. â³ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
7. â³ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## è”ç³»æ–¹å¼

- Team Lead: team-lead@worktree-dev-team
- é—®é¢˜åé¦ˆ: é€šè¿‡ SendMessage è”ç³»ç›¸åº”ä»£ç†

---

**æœ€åæ›´æ–°**: 2026-02-14
**ç‰ˆæœ¬**: v3 (ä¿®æ­£ç‰ˆ)
**çŠ¶æ€**: ğŸ”„ å¼€å‘ä¸­
